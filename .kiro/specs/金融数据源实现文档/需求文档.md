# ValueCell 金融数据源实现文档

## 项目概述

ValueCell 的金融数据源系统提供了统一的接口来访问多个金融数据提供商，支持全球主要市场的股票、ETF、指数和加密货币数据。系统采用适配器模式，实现了数据源的灵活切换和自动故障转移。

## 核心架构

### 1. 适配器模式架构

```
┌─────────────────────────────────────────────────────────┐
│                   AdapterManager                        │
│  (统一管理和路由多个数据源适配器)                          │
└─────────────────────────────────────────────────────────┘
                          │
        ┌─────────────────┼─────────────────┐
        │                 │                 │
┌───────▼────────┐ ┌──────▼──────┐ ┌───────▼────────┐
│  YFinance      │ │  AKShare    │ │  Future        │
│  Adapter       │ │  Adapter    │ │  Adapters      │
└────────────────┘ └─────────────┘ └────────────────┘
        │                 │                 │
┌───────▼────────┐ ┌──────▼──────┐ ┌───────▼────────┐
│  Yahoo         │ │  AKShare    │ │  Other         │
│  Finance API   │ │  Library    │ │  APIs          │
└────────────────┘ └─────────────┘ └────────────────┘
```

### 2. 核心组件

#### 2.1 BaseDataAdapter (基础适配器抽象类)
- **位置**: `python/valuecell/adapters/assets/base.py`
- **职责**: 定义所有数据源适配器必须实现的接口
- **核心方法**:
  - `search_assets()` - 搜索资产
  - `get_asset_info()` - 获取资产详细信息
  - `get_real_time_price()` - 获取实时价格
  - `get_historical_prices()` - 获取历史价格数据
  - `get_capabilities()` - 返回适配器支持的能力
  - `convert_to_source_ticker()` - 内部格式转换为数据源格式
  - `convert_to_internal_ticker()` - 数据源格式转换为内部格式

#### 2.2 YFinanceAdapter (Yahoo Finance 适配器)
- **位置**: `python/valuecell/adapters/assets/yfinance_adapter.py`
- **数据源**: Yahoo Finance API (通过 yfinance 库)
- **支持市场**:
  - 美国市场: NASDAQ, NYSE, AMEX
  - 中国市场: SSE (上交所), SZSE (深交所)
  - 香港市场: HKEX
  - 加密货币: CRYPTO
- **支持资产类型**: 股票、ETF、指数、加密货币
- **特点**:
  - 全球覆盖广泛
  - 数据质量高
  - 支持实时和历史数据
  - 支持多种时间间隔 (1m, 5m, 15m, 30m, 1h, 1d, 1w, 1mo)

#### 2.3 AKShareAdapter (AKShare 适配器)
- **位置**: `python/valuecell/adapters/assets/akshare_adapter.py`
- **数据源**: AKShare 库 (专注于中文金融市场)
- **支持市场**:
  - 中国A股: SSE, SZSE, BSE (北交所)
  - 香港市场: HKEX
  - 美国市场: NASDAQ, NYSE, AMEX
- **支持资产类型**: 股票、ETF、指数
- **特点**:
  - 中文市场数据更全面
  - 支持前复权 (qfq) 数据
  - 提供雪球 (XueQiu) API 集成
  - 支持分钟级实时数据

#### 2.4 AdapterManager (适配器管理器)
- **位置**: `python/valuecell/adapters/assets/manager.py`
- **职责**: 
  - 注册和管理多个数据源适配器
  - 智能路由请求到合适的适配器
  - 自动故障转移
  - 结果去重和合并
  - LLM 辅助的回退搜索

## 数据模型

### 1. 核心数据类型

#### Asset (资产)
```python
class Asset(BaseModel):
    ticker: str                          # 标准化格式: EXCHANGE:SYMBOL
    asset_type: AssetType                # 资产类型
    names: LocalizedName                 # 多语言名称
    descriptions: Dict[str, str]         # 多语言描述
    market_info: MarketInfo              # 市场信息
    source_mappings: Dict[DataSource, str]  # 数据源映射
    properties: Dict[str, Any]           # 额外属性
```

#### AssetPrice (资产价格)
```python
@dataclass
class AssetPrice:
    ticker: str                          # 资产代码
    price: Decimal                       # 当前价格
    currency: str                        # 货币
    timestamp: datetime                  # 时间戳
    volume: Optional[Decimal]            # 成交量
    open_price: Optional[Decimal]        # 开盘价
    high_price: Optional[Decimal]        # 最高价
    low_price: Optional[Decimal]         # 最低价
    close_price: Optional[Decimal]       # 收盘价
    change: Optional[Decimal]            # 涨跌额
    change_percent: Optional[Decimal]    # 涨跌幅
    market_cap: Optional[Decimal]        # 市值
    source: Optional[DataSource]         # 数据源
```

### 2. 枚举类型

#### AssetType (资产类型)
- `STOCK` - 股票
- `ETF` - 交易所交易基金
- `INDEX` - 指数
- `CRYPTO` - 加密货币

#### Exchange (交易所)
- `NASDAQ` - 纳斯达克
- `NYSE` - 纽约证券交易所
- `AMEX` - 美国证券交易所
- `SSE` - 上海证券交易所
- `SZSE` - 深圳证券交易所
- `BSE` - 北京证券交易所
- `HKEX` - 香港交易所
- `CRYPTO` - 加密货币市场

#### DataSource (数据源)
- `YFINANCE` - Yahoo Finance
- `AKSHARE` - AKShare

## Ticker 格式规范

### 内部标准格式
所有资产在系统内部使用统一的格式: `EXCHANGE:SYMBOL`

**示例**:
- 美股: `NASDAQ:AAPL`, `NYSE:JPM`
- A股: `SSE:600519`, `SZSE:000001`
- 港股: `HKEX:00700`, `HKEX:03033`
- 指数: `NASDAQ:IXIC`, `SSE:000001`
- 加密货币: `CRYPTO:BTC`, `CRYPTO:ETH`

### 数据源格式转换

#### YFinance 格式
- 美股: `AAPL` (无后缀)
- A股: `600519.SS` (上交所), `000001.SZ` (深交所)
- 港股: `0700.HK` (4位数字补零)
- 指数: `^IXIC` (加 ^ 前缀)
- 加密货币: `BTC-USD` (加货币后缀)

#### AKShare 格式
- 美股: `105.AAPL` (NASDAQ), `106.JPM` (NYSE), `107.GLD` (AMEX)
- 美股指数: `100.IXIC` (特殊代码 100)
- A股: `600519` (6位数字)
- 港股: `00700` (5位数字)

## 核心功能实现

### 1. 资产搜索

#### 搜索流程
```
用户输入查询
    ↓
并行搜索所有适配器
    ↓
收集所有结果
    ↓
智能去重 (基于交易所优先级)
    ↓
按相关性排序
    ↓
返回结果
    ↓
(如果无结果) LLM 辅助回退搜索
```

#### 去重策略
- 基于 `(symbol, country)` 识别重复
- 交易所优先级: NASDAQ > NYSE > AMEX (美股)
- 相同优先级时比较相关性分数

#### LLM 回退搜索
当常规搜索无结果时:
1. 使用 LLM 生成可能的 ticker 格式
2. 验证每个生成的 ticker
3. 返回有效的资产信息

### 2. 实时价格获取

#### 单个资产
```python
adapter_manager.get_real_time_price("NASDAQ:AAPL")
```

#### 批量获取 (优化性能)
```python
tickers = ["NASDAQ:AAPL", "NYSE:JPM", "SSE:600519"]
prices = adapter_manager.get_multiple_prices(tickers)
```

#### 自动故障转移
1. 根据 ticker 选择主适配器
2. 主适配器失败时自动尝试备用适配器
3. 更新缓存以使用成功的适配器

### 3. 历史数据获取

#### 支持的时间间隔
- 分钟级: `1m`, `5m`, `15m`, `30m`, `60m`
- 日级: `1d`
- 周级: `1w`
- 月级: `1mo`

#### 使用示例
```python
from datetime import datetime, timedelta

end_date = datetime.now()
start_date = end_date - timedelta(days=30)

prices = adapter_manager.get_historical_prices(
    ticker="NASDAQ:AAPL",
    start_date=start_date,
    end_date=end_date,
    interval="1d"
)
```

### 4. 资产信息获取

获取资产的详细信息，包括:
- 多语言名称
- 市场信息 (交易所、国家、货币、时区)
- 行业、板块信息
- 市值、PE 比率等财务指标
- 公司简介

```python
asset = adapter_manager.get_asset_info("NASDAQ:AAPL")
print(asset.get_localized_name("zh-Hans"))  # 中文名称
print(asset.market_info.currency)           # USD
```

## 智能路由机制

### 1. 能力注册
每个适配器注册其支持的能力:
```python
AdapterCapability(
    asset_type=AssetType.STOCK,
    exchanges={Exchange.NASDAQ, Exchange.NYSE, Exchange.AMEX}
)
```

### 2. 路由表构建
```
Exchange → List[Adapters]
NASDAQ → [YFinanceAdapter, AKShareAdapter]
SSE → [YFinanceAdapter, AKShareAdapter]
HKEX → [YFinanceAdapter, AKShareAdapter]
```

### 3. Ticker 缓存
- 首次查询时确定最佳适配器
- 缓存 `ticker → adapter` 映射
- 后续查询直接使用缓存

### 4. 故障转移
```
主适配器失败
    ↓
查找同交易所的备用适配器
    ↓
逐个尝试备用适配器
    ↓
成功后更新缓存
```

## 数据持久化

### 资产元数据存储
- 使用 SQLite 数据库存储资产信息
- 自动保存搜索和查询结果
- 支持离线查询缓存数据

### 数据库表结构
```sql
CREATE TABLE assets (
    symbol TEXT PRIMARY KEY,
    name TEXT,
    asset_type TEXT,
    description TEXT,
    sector TEXT,
    asset_metadata JSON,
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);
```

## 国际化支持

### 多语言名称
```python
class LocalizedName:
    names: Dict[str, str]  # 语言代码 → 名称
    
    # 支持的语言
    # - en-US: 英语 (美国)
    # - zh-Hans: 简体中文
    # - zh-Hant: 繁体中文
    # - zh-CN: 中国大陆
    # - zh-HK: 香港
```

### 市场信息本地化
- 货币: USD, CNY, HKD
- 时区: America/New_York, Asia/Shanghai, Asia/Hong_Kong
- 国家代码: US, CN, HK

## 性能优化

### 1. 并行请求
- 使用 `ThreadPoolExecutor` 并行查询多个适配器
- 批量价格查询时并行处理

### 2. 缓存机制
- Ticker → Adapter 映射缓存
- 减少重复的适配器选择开销

### 3. 批量 API 调用
- YFinance: 使用 `yf.download()` 批量获取多个股票
- 减少 API 调用次数

### 4. 超时控制
- 搜索超时: 15秒
- 批量价格获取超时: 60秒
- 单个请求超时: 10-30秒

## 错误处理

### 1. 适配器级别
- 捕获所有异常并记录日志
- 返回 None 或空列表而不是抛出异常
- 提供详细的错误信息用于调试

### 2. 管理器级别
- 自动故障转移到备用适配器
- 聚合多个适配器的结果
- 确保至少返回部分结果

### 3. 数据验证
- Ticker 格式验证
- 价格数据有效性检查 (NaN, None)
- 日期范围验证

## 扩展性设计

### 添加新的数据源适配器

1. **创建适配器类**
```python
class NewAdapter(BaseDataAdapter):
    def __init__(self, **kwargs):
        super().__init__(DataSource.NEW_SOURCE, **kwargs)
    
    def _initialize(self):
        # 初始化配置
        pass
    
    # 实现所有抽象方法
    def search_assets(self, query): ...
    def get_asset_info(self, ticker): ...
    def get_real_time_price(self, ticker): ...
    def get_historical_prices(self, ticker, start, end, interval): ...
    def get_capabilities(self): ...
    def convert_to_source_ticker(self, ticker): ...
    def convert_to_internal_ticker(self, source_ticker, default_exchange): ...
```

2. **注册适配器**
```python
adapter_manager = get_adapter_manager()
adapter_manager.register_adapter(NewAdapter())
```

3. **自动集成**
- 路由表自动更新
- 故障转移自动生效
- 无需修改现有代码

## 使用示例

### 基础使用
```python
from valuecell.adapters.assets.manager import get_adapter_manager

# 获取管理器实例
manager = get_adapter_manager()

# 配置适配器
manager.configure_yfinance()
manager.configure_akshare()

# 搜索资产
from valuecell.adapters.assets.types import AssetSearchQuery
query = AssetSearchQuery(query="苹果", limit=10)
results = manager.search_assets(query)

# 获取资产信息
asset = manager.get_asset_info("NASDAQ:AAPL")
print(f"名称: {asset.get_localized_name('zh-Hans')}")
print(f"交易所: {asset.market_info.exchange}")

# 获取实时价格
price = manager.get_real_time_price("NASDAQ:AAPL")
print(f"当前价格: {price.price} {price.currency}")
print(f"涨跌幅: {price.change_percent}%")

# 获取历史数据
from datetime import datetime, timedelta
end_date = datetime.now()
start_date = end_date - timedelta(days=30)
prices = manager.get_historical_prices(
    "NASDAQ:AAPL", 
    start_date, 
    end_date, 
    "1d"
)
```

### 批量操作
```python
# 批量获取价格
tickers = ["NASDAQ:AAPL", "NYSE:JPM", "SSE:600519"]
prices = manager.get_multiple_prices(tickers)

for ticker, price in prices.items():
    if price:
        print(f"{ticker}: {price.price} {price.currency}")
```

### 自选股管理
```python
from valuecell.adapters.assets.manager import get_watchlist_manager

# 获取自选股管理器
watchlist_mgr = get_watchlist_manager()

# 创建自选股
watchlist = watchlist_mgr.create_watchlist(
    user_id="user123",
    name="我的自选股",
    description="科技股组合"
)

# 添加资产
watchlist_mgr.add_asset_to_watchlist(
    user_id="user123",
    ticker="NASDAQ:AAPL",
    notes="长期持有"
)

# 获取自选股价格
prices = watchlist_mgr.get_watchlist_prices(user_id="user123")
```

## 配置说明

### 环境变量
```bash
# 雪球 Token (可选，用于 AKShare 获取更详细的资产信息)
XUEQIU_TOKEN=your_token_here

# LLM 配置 (用于回退搜索)
PRODUCT_MODEL_ID=your_model_id
```

### 依赖包
```toml
[project.dependencies]
yfinance = ">=0.2.65"
akshare = ">=1.17.44"
pandas = ">=2.0.0"
```

## 最佳实践

### 1. 选择合适的数据源
- **美股**: 优先使用 YFinance (数据更全面)
- **A股**: 优先使用 AKShare (中文数据更准确)
- **港股**: 两者都可以，AKShare 中文名称更准确
- **加密货币**: 使用 YFinance

### 2. 批量操作
- 尽量使用 `get_multiple_prices()` 而不是循环调用
- 减少 API 调用次数，提高性能

### 3. 错误处理
- 始终检查返回值是否为 None
- 使用 try-except 捕获可能的异常
- 记录详细的错误日志

### 4. 缓存策略
- 实时价格数据缓存时间: 1-5分钟
- 资产信息缓存时间: 1天
- 历史数据可以长期缓存

## 未来规划

### 短期 (1-3个月)
- [ ] 添加更多数据源 (Tushare, Finnhub)
- [ ] 支持期权、期货数据
- [ ] 优化批量查询性能
- [ ] 添加数据质量监控

### 中期 (3-6个月)
- [ ] 实现分布式缓存 (Redis)
- [ ] 添加实时 WebSocket 数据流
- [ ] 支持更多市场 (欧洲、日本)
- [ ] 实现智能数据源选择 (基于质量和延迟)

### 长期 (6-12个月)
- [ ] 构建自有数据聚合服务
- [ ] 机器学习驱动的数据质量评估
- [ ] 支持自定义数据源插件
- [ ] 实现数据版本控制和回溯

## 总结

ValueCell 的金融数据源系统通过适配器模式实现了:
- ✅ 统一的数据访问接口
- ✅ 多数据源自动故障转移
- ✅ 智能路由和缓存
- ✅ 全球主要市场覆盖
- ✅ 高性能批量操作
- ✅ 完善的国际化支持
- ✅ 易于扩展的架构

这个系统为 ValueCell 的各个智能体提供了可靠、高效的金融数据支持。
